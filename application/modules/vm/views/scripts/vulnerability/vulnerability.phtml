<?php
    $vulnerability = $this->vulnerability;
?>

<div class="column left">
    <div>
        <?php Fisma_Format_Section::startSection("Details"); ?>
        <table class="keyValues">
            <tr>
                <td>Vulnerability ID:</td>
                <td><?php echo $this->escape($vulnerability->id)?></td>
            </tr>
            <tr>
                <td>Date Discovered:</td>
                <td><?php echo $this->escape($vulnerability->discoveredDate)?></td>
            </tr>
            <tr>
                <td>Date Opened:</td>
                <td><?php echo $this->escape($vulnerability->createdTs)?></td>
            </tr>
            <tr>
                <td>Date Fixed:</td>
                <td>
                    <?php 
                    if (!is_null($vulnerability->closedTs)) {
                        echo $this->escape($vulnerability->closedTs);
                    } else {
                        echo $this->escape("<i>Not fixed</i>", 'none');
                    }
                    ?>
                </td>
            </tr>
            <tr>
                <td>Status:</td>
                <td><?php echo $this->escape($vulnerability->status, 'none');
                    if (!is_null($this->wontFixStatus)):
                        echo $this->escape(' (') . $this->escape($this->wontFixStatus) . $this->escape(')');
                    endif?></td>

            </tr>
        </table>
        <?php Fisma_Format_Section::stopSection(); ?>
    </div>
</div>
<div class="column right">
    <?php Fisma_Format_Section::startSection('Description'); ?>

        <?php echo $this->escape($vulnerability->description, 'none'); ?>

    <?php Fisma_Format_Section::stopSection(); ?>
</div>

<div class="clear"></div>

<div>

<?php Fisma_Format_Section::startSection('Recommendation'); ?>
<div>
    <?php echo $this->escape($vulnerability->recommendation, 'none'); ?>
</div>
<?php Fisma_Format_Section::stopSection(); ?>
<?php
    // @todo english
    $threatText    = "<p>A threat is the potential for a particular threat-source to successfully exercise a "
                   . "particular vulnerability. A vulnerability is a bug, flaw, weakness, or exposure of an "
                   . "application, system, device, or service that could lead to a failure of confidentiality, "
                   . "integrity, or availability. The threat level allows the organization to prioritize "
                   . "security weaknesses based on their level of threat to the information system. Usually, "
                   . "the security level and description are pre-populated from vulnerability scan data, "
                   . "however, manually created vulnerabilities need an assigned threat level and description.</p>";
    $threatTooltip = new Fisma_Yui_Tooltip('threat', 'Threat', $threatText);
    Fisma_Format_Section::startSection($threatTooltip);
?>
    <?php echo $this->escape($vulnerability->threat, 'none'); ?>
<?php Fisma_Format_Section::stopSection(); ?>

<?php 
Fisma_Format_Section::startSection("Cross-References");
?>
    <p>
        Cross-references are typically provided by automated scanners. These cross-references link to external websites
        which may be able to provide additional context and/or technical detail for this vulnerability.
    </p>
    <table class="keyValues">
        <?php 
        if ($vulnerability->Bugtraqs->count() > 0): 
            foreach ($vulnerability->Bugtraqs as $bugtraq):
        ?>
                <tr>
                    <td>
                        Bugtraq:
                    </td>
                    <td>
                        <a href="<?php echo $this->escape($bugtraq->getUrl(), 'none'); ?>">
                            <?php echo $this->escape($bugtraq->value); ?>
                        </a>
                    </td>
                </tr>
        <?php 
            endforeach;
        else: 
        ?>
            <tr>
                <td>
                    Bugtraq:
                </td>
                <td>
                    <i>No Bugtraq cross-references available</i>
                </td>
            </tr>
        <?php
        endif;
        ?>

        <?php 
        if ($vulnerability->Cves->count() > 0): 
            foreach ($vulnerability->Cves as $cve):
        ?>
                <tr>
                    <td>
                        CVE:
                    </td>
                    <td>
                        <a href="<?php echo $this->escape($cve->getUrl(), 'none'); ?>">
                            <?php echo $this->escape($cve->value); ?>
                        </a>
                    </td>
                </tr>
        <?php 
            endforeach;
        else: 
        ?>
            <tr>
                <td>
                    CVE:
                </td>
                <td>
                    <i>No CVE cross-references available</i>
                </td>
            </tr>
        <?php
        endif;
        ?>

        <?php 
        if ($vulnerability->Xrefs->count() > 0): 
            foreach ($vulnerability->Xrefs as $xref):
                $url = $xref->getUrl();
        ?>
                <tr>
                    <td>
                        Xref:
                    </td>
                    <td>
                        <?php if (!is_null($url)): ?>
                        <a href="<?php echo $this->escape($url, 'none'); ?>">
                            <?php echo $this->escape($xref->value); ?>
                        </a>
                        <?php else: ?>
                            <?php echo $this->escape($xref->value); ?> (No link available)
                        <?php endif; ?>
                    </td>
                </tr>
        <?php 
            endforeach;
        else: 
        ?>
            <tr>
                <td>
                    Xref:
                </td>
                <td>
                    <i>No Xref cross-references available</i>
                </td>
            </tr>
        <?php
        endif;
        ?>
    </table>
<?php
Fisma_Format_Section::stopSection(); 
?>

</div>
