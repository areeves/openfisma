<?php
    $finding = $this->finding;
    $status  = $finding->getStatus();
?>
<div id='finding_detail_panel'><?php
echo $this->partial(
    'remediation/finding-detail.partial.phtml',
    'finding',
    array(
        'finding' => $finding,
        'isLegacyFindingKeyEditable' => $this->isLegacyFindingKeyEditable,
        'isSourceEditable' => $this->isSourceEditable,
        'isOrganizationEditable' => $this->isOrganizationEditable,
        'isPocEditable' => $this->isPocEditable
    )
);
?></div>

<?php
    Fisma_Format_Section::startSection("Details");
?>
<table class="keyValues">
    <tr>
        <td>Legacy Finding Key:</td>
        <td>
            <span
                <?php
                if ($this->isLegacyFindingKeyEditable) {
                ?>
                    id="legacyFindingKey"
                    class="editable"
                    target="legacyFindingKey"
                    name="finding[legacyFindingKey]"
                    type="text"
                <?php
                }
                ?>>
                <?php echo $this->escape($finding->legacyFindingKey); ?>&nbsp;
            </span>
        </td>
    </tr>
    <tr>
        <td>Source:</td>
        <td>
            <span id="source"
                  type="select"
                  name="finding[sourceId]"
                  href="/metainfo/list/o/source/format/html/"
                  value="<?php echo $this->escape($finding->Source->id); ?>">
                  <?php
                  $sourceName = $finding->Source->nickname . ' - ' . $finding->Source->name;
                  if ($this->acl()->hasPrivilegeForObject('read', $finding->Source)):
                  ?>
                      <a href="/finding/source/view/id/<?php echo $this->escape($finding->Source->id); ?>">
                         <?php echo $this->escape($sourceName);?>
                      </a>
                  <?php
                  else:
                      echo $this->escape($sourceName);
                  endif;
                  ?>
            </span>

            <?php
            if ($this->isSourceEditable):
            ?>
                <span class="editable" target="source">&nbsp;</span>
            <?php
            endif;
            ?>

        <?php if ($finding->uploadId): ?>
            <br><?php echo $this->escape($finding->Upload->fileName)?>
        <?php endif; ?>
        </td>
    </tr>
    <tr>
        <td>
            <div>
                Organization/System:
            </div>
        </td>
        <td>
            <span id="organization"
                  type="select"
                  name="finding[responsibleOrganizationId]"
                  href="/metainfo/list/o/system/format/html/"
                  value="<?php echo $this->escape($finding->responsibleOrganizationId); ?>">
            <a href="<?php echo $this->escape($this->organizationViewUrl); ?>">
                 <?php echo $this->escape($finding->Organization->nickname);?>
                 - <?php echo $this->escape($finding->Organization->name);?>
            </a>
            </span>

            <?php
            if ($this->isOrganizationEditable):
            ?>
                <span class="editable" target="organization">&nbsp;</span>
            <?php
            endif;
            ?>
        </td>
    </tr>
    <tr>
        <td>Status:</td>
        <td title="<?php echo $this->escape($status); ?>">
            <?php echo $this->escape($finding->getLongStatus()); ?>
        </td>
    </tr>
    <?php if ($status != 'CLOSED'): ?><tr>
        <td>On Time:</td>
        <td>
        <?php if (is_null($finding->nextDueDate)): ?>
            N/A
        <?php elseif (time() <= strtotime($finding->nextDueDate)): ?>
            On Time
        <?php else: ?>
            Overdue
        <?php endif; ?>
        </td>
    </tr><?php endif; ?>
    <tr>
        <td>Threat Level:</td>
        <td><?php echo $this->escape($finding->threatLevel); ?></td>
    </tr>
</table>
<?php Fisma_Format_Section::stopSection();



if ($this->isDescriptionEditable) {
    Fisma_Format_Section::startSection('Description', 'finding_description');
} else {
    Fisma_Format_Section::startSection('Description');
}
?>
<div name="finding[description]" id="finding_description" type="textarea" rows="3" cols="160">
    <?php echo $this->escape($finding->description, 'none'); ?>
</div>
<?php Fisma_Format_Section::stopSection(); ?>

<?php
if ($this->isRecommendationEditable) {
    Fisma_Format_Section::startSection('Recommendation', 'recommendation');
} else {
    Fisma_Format_Section::startSection('Recommendation');
}
?>
<div name="finding[recommendation]" id="recommendation" type="textarea" rows="3" cols="160">
    <?php echo $this->escape($finding->recommendation, 'none'); ?>
</div>
<?php Fisma_Format_Section::stopSection(); ?>

<?php
echo $this->partial(
    'remediation/poam-table.partial.phtml',
    'finding',
    array(
        'finding' => $finding,
        'isMitigationStrategyEditable' => $this->isMitigationStrategyEditable,
        'isTypeEditable' => $this->isTypeEditable
    )
);
?>

<?php
echo $this->partial(
    'remediation/poam-approval.partial.phtml',
    'finding',
    array(
        'finding' => $finding,
        'approvalHistory' => $this->approvalHistory
    )
);
?>