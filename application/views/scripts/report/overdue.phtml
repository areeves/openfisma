<?php
    $currentYear = date('Y');
    $yearList[0] = 'All Fiscal Year';
    for ($year=2005; $year<=$currentYear; $year++) {
        $yearList[$year] = $year;
    }
    $overdue['type'] = array('0' => '--Any--',
                         'sso' => 'Mitigation Strategy',
                         'action'   =>'Corrective Action');
    $overdue['day'] = array('1' => '<30 days',
                            '2' => '30-59 days',
                            '3' => '60-89 days',
                            '4' => '90-119 days',
                            '5' => '120+ days');
    if (!empty($this->systemList)) {$this->systemList[0] = '--Any--'; ksort($this->systemList);}
    if (!empty($this->sourceList)) {$this->sourceList[0] = '--Any--'; ksort($this->sourceList);}
    $url = "/panel/report/sub/overdue/s/search";
?>

<form name="overdue_report" method="post" action="/panel/report/sub/overdue/s/search">
    <div class="searchFilters">
        <p>
            <b>System</b>
            <?php 
                echo $this->formSelect('orgSystemId',
                                     isset($this->params['orgSystemId'])?$this->params['orgSystemId']:0, 
                                     null,$this->systemList);
                if( !empty($this->params['orgSystemId']) ) {
                    $url .= '/system_id/'.$this->params['orgSystemId'];
                }
                echo new Fisma_Yui_Form_Button_Submit('generateOverdueReport', array('label' => 'Generate Report'));
                echo new Fisma_Yui_Form_Button('advanced_search',
                                                array('label' => 'Toggle Advanced Search Options',
                                                      'onClickFunction' => 'toggleSearchOptions'));
            ?>
        </p>
        <p id="advanced_searchbox" style="<?php if (empty($this->params['overdueType']) && empty($this->params['sourceId'])) { ?>display:none<?php } ?>">
            <b>Overdue type</b>
            <?php echo $this->formSelect('overdueType',
                                        isset($this->params['overdueType'])?$this->params['overdueType']:0,
                                        null, $overdue['type']);
            ?>
            <b>Source</b>
            <?php echo $this->formSelect('sourceId',
                                         isset($this->params['sourceId'])?$this->params['sourceId']:0, 
                                         null,$this->sourceList);
                  if( !empty($this->params['sourceId']) ) {
                      $url .= '/sourceId/'.$this->params['sourceId'];
                  }
            ?>
        </p>
    </div>
</form>

<?php if( !empty($this->poamList) ) { ?>
<?php Fisma_Format_Section::startSection("Poam Search Results"); ?>
    <div class="toolbar">
        <?php echo $this->links['all']; ?>
        <?php 
            echo new Fisma_Yui_Form_Button_Link('exportPdf',
                                          array('value' => 'Export PDF', 
                                                'href' => $this->url.'/format/pdf', 
                                                'imageSrc' => '/images/pdf.gif'));
            echo new Fisma_Yui_Form_Button_Link('exportExcel',
                                          array('value' => 'Export Excel', 
                                                'href' => $this->url.'/format/xls', 
                                                'imageSrc' => '/images/xls.gif'));
        ?>
    </div>
<div id="overdue_report"></div>
<script type="text/javascript">
// Column definitions
var myColumnDefs = [
<?php foreach ($this->columns as $key => $val) { ?>
    <?php if (!isset($i)) { $i = true; } else { echo ','; } ?>{key:"<?php echo $key; ?>", label:"<?php echo $val; ?>", sortable: true, hidden: false}
<?php } unset($i); ?>];
    var dataSource = { rows: [
    <?php foreach ($this->poamList as $row) { 
          if (!isset($i)) { $i = true; } else { echo ','; } ?>
          {<?php  foreach ($this->columns as $key => $val) { 
                    if (!isset($n)) { $n = true; } else { echo ','; }
                    if ($key != 'orgSystemName' && $key != 'type') {
                        echo $key . ':' . $row[$key];
                    } else {
                        echo $key . ":'" . $row[$key] . "'";
                    }
                }
                unset($n); ?>}
    <?php }
          unset($i); ?> ] };
    var myDataSource = new YAHOO.util.DataSource(dataSource.rows);
    
    // DataTable configuration
    var myConfigs = {
        dynamicData: false,
        sortedBy : {key:"orgSystemName", dir:YAHOO.widget.DataTable.CLASS_ASC}
    };
    var myDataTable = new YAHOO.widget.DataTable("overdue_report", myColumnDefs, myDataSource, myConfigs);
    myDataTable.subscribe("rowMouseoverEvent", myDataTable.onEventHighlightRow); 
    myDataTable.subscribe("rowMouseoutEvent", myDataTable.onEventUnhighlightRow);
</script>

<?php } ?>

<?php Fisma_Format_Section::stopSection(); ?>
