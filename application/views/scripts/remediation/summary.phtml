<?php
    $this->sources[0] = '--Any--';
    $this->systems[0] = '--Any--';
    $typeList = array('0' =>'--Any--', 'NONE' => 'NONE', 'CAP'=>'CAP', 'AR'=>'AR', 'FP'=>'FP');
    $aging   = array('0' => '--Any--',
                      '30'=>'30+ Days Old',
                      '60'=>'60+ Days Old',
                      '90'=>'90+ Days Old',
                      '120'=>'120+ Days Old');
    $statusArray = array_merge($this->statusArray, array('CLOSED'));
?>
<form name="filters" method="post" action="/panel/remediation/sub/summary">
<!-- Begin Filter Table -->
<table class="searchFilters">
    <tr>
        <td><b>Finding Source: </b>
         </td><td>   <?php echo $this->formSelect('source_id', $this->criteria['sourceId'], null, $this->sources);?>
        </td>
        <td><b>Mitigation Strategy: </b>
        </td><td>    <?php echo $this->formSelect('type', $this->criteria['type'], null, $typeList);?>
        </td>
        <td><b>Aging Totals: </b>
        </td><td>    <?php echo $this->formSelect('aging', $this->criteria['aging'], array('id'=>'remediationSearchAging'), $aging); ?>
        </td>
    </tr>
    <tr>
        <td><b>Date Opened From: </b></td><td><input type="text" class="date" id="created_date_begin" name="created_date_begin" value="<?php
            echo $this->criteria['created_date_begin']; ?>"
            size="12" maxlength="20"></td>
        <td><b>Date Opened To: </b></td><td><input type="text" class="date" id="created_date_end" name="created_date_end" value="<?php
            echo $this->criteria['created_date_end']; ?>"
            size="12" maxlength="20"></td>
        <td colspan="2"><?php echo new Yui_Form_Button_Submit('filterRemediationSummarySubmit', array('value' => 'Apply Filter')); ?></td>
    </tr>
</table>
</form>

<?php Format_Section::startSection("Remediation Summary"); ?>

<table align="center" class="tipframe" width="90%" cellpadding="0" cellspacing="0">
    <tr align="center" bgcolor="#f3f3f3">
        <td class="tdc"></td>
        <td colspan="<?php echo $this->mpCount+2;?>" class="tdc">Mitigation Strategy</td>
        <td colspan="<?php echo $this->epCount+1;?>" class="tdc">Remediation</td>
        <td colspan="2" class="tdc"></td>
    </tr>
    <tr align="center" bgcolor="#f3f3f3">
        <td class="tdc">Action Owner</td>
        <?php
            foreach ($statusArray as $v) {
                echo '<td class="tdc">'.$v.'</td>';
            }
        ?>
        <td class="tdc">Total</td>
    </tr>

<!-- SUMMARY LOOP -->
<?php
    define('BASE', "/panel/remediation/sub/searchbox/s/search");

    foreach($this->summary as $sid=>$row){

	if (isset($this->systems[$sid])) {

        $base_url = BASE . '/system_id/' . $sid . $this->criteriaUrl;
        $flag = false;
        echo '<tr>';
        echo '<td width="20%" align="left" class="tdc" bgcolor="#f3f3f3">'.$this->systems[$sid].'</td>';

        foreach ($statusArray as $status) {
            if (isset($row[$status."overdue"])) {
                $flag = true;
            }
        }
    
        foreach ($statusArray as $status) {
            $normalHref = $base_url.'/status/'.$status.'/ontime/ontime';
            $overdueHref = $base_url.'/status/'.$status.'/ontime/overdue';
            echo '<td align="center" class="tdc" bgcolor="#d9ead3">';
            if ($flag) {
                echo '<table width="100%" cellspacing="0" cellpadding="0"><tr bgcolor="#d9ead3" align="center"><td>';
                if (isset($row[$status.'overdue'])) {
                    $normalCount = $row[$status] - $row[$status.'overdue'];
                    echo $normalCount == ''?'-':'<a href="'.$normalHref.'">'.$normalCount.'</a>';
                    echo '</td></tr>';
                    echo '<tr bgcolor="#f4cccc" align="center"><td><em><a href="'.$overdueHref.'">'.$row[$status."overdue"].'</a></em>';
                } else {
                    echo $row[$status] == ''?'-':'<a href="'.$base_url.'/status/'.$status.'">'.$row[$status].'</a>';
                    echo '</td></tr><tr bgcolor="#f4cccc" align="center"><td>-';
                }
                echo '</td></tr></table>';
            } else {
                echo $row[$status] == ''?'-':'<a href="'.$base_url.'/status/'.$status.'">'.$row[$status].'</a>';
            }
            echo '</td>';
        }
        echo '<td align="center" class="tdc" bgcolor="#d9ead3">';
        echo $row['TOTAL'] == ''?'-':'<a href="'.$base_url.'">'.$row['TOTAL'].'</a>';
        echo '</td></tr>';
	}
    }
    echo '<tr bgcolor="#f3f3f3">';
    echo '<td width="20%" align="center" class="tdc"><b>TOTALS</b></td>';
    $total_url = BASE . $this->criteriaUrl;
    foreach ($statusArray as $status) {
        echo '<td align="center" class="tdc">';
        echo $this->total[$status] == '0'?'<b>0</b>':'<a href="'.$total_url.'/status/'.$status.'"><b>'.$this->total[$status].'</b></a></b>';
        echo '</td>';
    }
    echo '<td align="center" class="tdc">';
    echo $this->total['TOTAL'] == '0'?'<b>0</b>':'<a href="'.$total_url.'"><b>'.$this->total['TOTAL'].'</b></a>';
    echo '</td></tr>';
?>
<!-- END SUMMARY LOOP -->
</table>

<?php Format_Section::stopSection(); ?>
