<?php
    $filterType = array(0  =>'--Any--',
                    'NONE'  =>'NONE',
                    'CAP'  =>'(CAP) Corrective Action Plan',
                    'AR'   =>'(AR) Accepted Risk',
                    'FP'   =>'(FP) False Positive');
    $onTimes    = array(0 =>'--Any--',
                        'ontime'=>'On Time',
                        'overdue'=>'Overdue');
    
    $evaluationTable = Doctrine::getTable('Evaluation');
    $mpEvalList = $evaluationTable->findByApprovalGroup('action');
    $epEvalList = $evaluationTable->findByApprovalGroup('evidence');

    foreach ($mpEvalList as $row) {
        $mpStatus[$row->nickname] = '(' . $row->nickname . ')' . $row->name;
    }
    foreach ($epEvalList as $row) {
        $epStatus[$row->nickname] = '(' . $row->nickname . ')' . $row->name;
    }

    $filterStatus = array(  0   =>'--Any--',
                           'NEW' =>'(NEW) Awaiting Mitigation Type and Approval',
                           'DRAFT'=>'(DRAFT) Awaiting Mitigation Approval');
    $filterStatus = array_merge($filterStatus, $mpStatus);
    $filterStatus['EN'] = '(EN) Evidence Needed';
    $filterStatus = array_merge($filterStatus, $epStatus);
    $filterStatus['CLOSED'] = '(CLOSED) Officially Closed';
    $filterStatus['NOT-CLOSED'] = '(NOT-CLOSED) Not Closed';
    $filterStatus['NOUP-30']   = '(NOUP-30) 30+ Days Since Last Update';
    $filterStatus['NOUP-60']   = '(NOUP-60) 60+ Days Since Last Update';
    $filterStatus['NOUP-90']   = '(NOUP-90) 90+ Days Since Last Update';

    $this->systems = array('--Any--') + (array)$this->systems;
    $this->sources = array('--Any--') + (array)$this->sources;

    $bookmarkUrl = 'http://' . Configuration::getConfig('host_url') . '/panel/remediation/sub/searchbox/';

    $flag = '';
    foreach ($this->params as $k => $value) {
        if (!empty($value) && $k != 'keywords' && $k != 'evidence_include') {
            $flag = 'true';
            $bookmarkUrl .= $k . '/' . $value . '/';
        }
    }
?>
<form name="filters" method="post" action="/panel/remediation/sub/searchbox">
<div class="searchFilters">
        <span class="searchField"><b>Search: </b>
        <input type="hidden" name="expanded" value="true">
        <input type="text" 
               name="keywords" 
               size="50" 
               value='<?php echo $this->params['keywords'];?>'></span>
    <?php 
        echo new Fisma_Yui_Form_Button_Submit('remediationSearchSubmit',
                                              array('label' => 'Search'));
        echo new Fisma_Yui_Form_Button('advanced_search',
                                            array('label' => 'Toggle Advanced Search Options',
                                                  'onClickFunction' => 'toggleSearchOptions'));
        $helpButton = new Fisma_Yui_Form_Button('searchHelp', 
                                          array('label' => 'Help', 
                                                'imageSrc' => '/images/help.png',
                                                'onClickFunction' => 'showHelp',
                                                'onClickArgument' => 'search'));
        echo $helpButton; 
        echo new Fisma_Yui_Form_Button(
            'bookmark', 
            array(
                'label' => 'Bookmark', 
                'onClickFunction' => 'addBookmark', 
                'onClickArgument' => array('title' => 'OpenFISMA Search Results', 'href' => $bookmarkUrl)
            )
        );
    ?>
</div>

<?php
$style = $flag == ''
       ? 'style="display:none"'
       : '';
?>
<div id="advanced_searchbox" class="searchFilters" <?php echo $style; ?>>
<!-- Begin Filter Table -->
<table style="text-align:left">
    <tr>
        <td><b>Finding Source: </b><br>
            <?php 
            echo $this->formSelect(
                'sourceId',
                 $this->params['sourceId'],
                 null,
                 $this->sources
            );
            ?>
        </td>
        <td>
        <b>ID: </b><i>(You may select multiple IDs by using a comma separated list - x,y,z)</i><br>
        <input type="text" size="70" name="ids" value="<?php echo $this->params['ids'];?>">
        </td>
    </tr>
    <tr>
        <td ><b> Mitigation Strategy:</b><br>
        <?php 
        echo $this->formSelect(
            'type',
             $this->params['type'],
             null,
             $filterType
        );
        ?>
        </td>
        <td width="318" valign="top"><b> Finding Status:</b><br>
        <?php 
        echo $this->formSelect(
            'status', 
             $this->params['status'], 
             array('id'=>'poamSearchStatus'),
             $filterStatus
        );
        ?>
        </td>
    </tr>
    <tr>
        <td><b>Responsible System: </b><br>
            <?php 
            echo $this->formSelect(
                'responsibleOrganizationId',
                 $this->params['responsibleOrganizationId'],
                 null,
                 $this->systems
            );
            ?>
        </td>
        <td ><b>On Time:</b><br>
            <?php 
            echo $this->formSelect(
                'ontime',
                 $this->params['ontime'],
                 array('id'=>'poamSearchOnTime'),
                 $onTimes
            );
            ?>
        </td>
    </tr>
    <tr>
        <td colspan='2'>
            <table border="0" cellpadding="3" cellspacing="1" width="98%">
                <tr>
                    <td><b>Estimated Completion Date:</b></td>
                    <td> 
                        From: 
                        <input type="text" 
                               class="date" 
                               id="estDateBegin" 
                               name="estDateBegin" 
                               value="<?php echo !empty($this->params['estDateBegin']) 
                                                 ? $this->params['estDateBegin']->toString('Y-m-d') 
                                                 : ''; ?>" 
                               size="12" 
                               maxlength="10"
                               onfocus="showCalendar('estDateBegin', 'estDateBegin_show');">
                        <img id="estDateBegin_show" src="/images/calendar.gif" width="18" height="18" alt="Calendar">
                    </td>
                        
                    <td > To: <input type="text" class="date" id="estDateEnd" name="estDateEnd" value="<?php
                        echo !empty($this->params['estDateEnd'])?$this->params['estDateEnd']->toString('Y-m-d'):'';
                        ?>" size="12" maxlength="10">
                        <img id="estDateEnd_show" src="/images/calendar.gif" width="18" height="18" alt="Calendar" >
                    </td>
                        
                    <td><b>Date Created: </b></td>
                    <td>
                        From: 
                        <input type="text" 
                               class="date" 
                               id="createdDateBegin" 
                               name="createdDateBegin" 
                               value="<?php 
                                   echo !empty($this->params['createdDateBegin']) 
                                        ? $this->params['createdDateBegin']->toString('Y-m-d')
                                        : '';
                                   ?>" 
                               size="12" 
                               maxlength="10">
                        <img id="createdDateBegin_show" 
                             src="/images/calendar.gif" 
                             width="18" 
                             height="18" 
                             alt="Calendar">
                    </td>
                        
                    <td>
                        To: 
                        <input type="text" 
                               class="date" 
                               id="createdDateEnd" 
                               name="createdDateEnd" 
                               value="
                                   <?php
                                   echo !empty($this->params['createdDateEnd'])
                                        ? $this->params['createdDateEnd']->toString('Y-m-d')
                                        : '';
                                   ?>" 
                               size="12" 
                               maxlength="10">
                        <img id="createdDateEnd_show" src="/images/calendar.gif" width="18" height="18" alt="Calendar">
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</form>
</div>

<?php //Fisma_Format_Section::stopSection(); ?>
