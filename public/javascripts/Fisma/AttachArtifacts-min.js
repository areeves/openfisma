Fisma.AttachArtifacts={sampleInterval:1000,apcId:null,yuiProgressBar:null,pollingTimeoutId:null,lastAsyncRequest:null,pollingEnabled:false,config:null,yuiPanel:null,showPanel:function(d,b){Fisma.AttachArtifacts.config=b;var a=new YAHOO.widget.Panel("panel",{modal:true,close:true});a.setHeader("Upload Artifact");a.setBody("Loading...");a.render(document.body);a.center();a.show();a.hideEvent.subscribe(function(){Fisma.AttachArtifacts.cancelPanel.call(Fisma.AttachArtifacts)});Fisma.AttachArtifacts.yuiPanel=a;var c="/artifact/upload-form";if(b.form){c+="/form/"+encodeURIComponent(b.form)}YAHOO.util.Connect.asyncRequest("GET",c,{success:function(e){e.argument.setBody(e.responseText);e.argument.center()},failure:function(e){e.argument.setBody("The content for this panel could not be loaded.");e.argument.center()},argument:a},null)},trackUploadProgress:function(){var h=document.getElementById("fileUpload");if(""===h.value){var a="Please select a file.";var c={zIndex:10000};Fisma.Util.showAlertDialog(a,c);return false}var i=document.getElementById("uploadButton");i.disabled=true;var g=this;var e=document.getElementById("progress_key");if(e){this.apcId=e.value;var k=document.getElementById("progressBarContainer");var b=parseInt(YAHOO.util.Dom.getStyle(k,"width"),10);var f=parseInt(YAHOO.util.Dom.getStyle(k,"height"),10);YAHOO.util.Dom.removeClass(k,"attachArtifactsProgressBar");while(k.hasChildNodes()){k.removeChild(k.firstChild)}var j=new YAHOO.widget.ProgressBar();j.set("width",b);j.set("height",f);j.set("ariaTextTemplate","Upload is {value}% complete");j.set("anim",true);var d=j.get("anim");d.duration=2;d.method=YAHOO.util.Easing.easeNone;j.render("progressBarContainer");YAHOO.util.Dom.addClass(k,"attachArtifactsProgressBar");this.yuiProgressBar=j;this.pollingEnabled=true;setTimeout(function(){g.getProgress.call(g)},this.sampleInterval)}document.getElementById("progressBarContainer").style.display="block";document.getElementById("progressTextContainer").style.display="block";setTimeout(function(){g.postForm.call(g)},0);return false},postForm:function(){var a=this;var b="/";b+=encodeURIComponent(this.config.server.controller);b+="/";b+=encodeURIComponent(this.config.server.action);b+="/id/";b+=encodeURIComponent(this.config.id);b+="/format/json";YAHOO.util.Connect.setForm("uploadArtifactForm",true);YAHOO.util.Connect.asyncRequest("POST",b,{upload:function(c){a.handleUploadComplete.call(a,c)},failure:function(c){Fisma.Util.showAlertDialog("Document upload failed.")}},null)},getProgress:function(){var a=this;if(this.pollingEnabled){this.lastAsyncRequest=YAHOO.util.Connect.asyncRequest("GET","/artifact/upload-progress/format/json/id/"+this.apcId,{success:function(d){try{var c=YAHOO.lang.JSON.parse(d.responseText)}catch(g){if(g instanceof SyntaxError){c=new Object();c.progress=false}else{throw g}}if(!c.progress){a.yuiProgressBar.destroy();a.yuiProgressBar=null;a.pollingEnabled=false;var i=document.getElementById("progressBarContainer");YAHOO.util.Dom.addClass(i,"attachArtifactsProgressBar");var b=document.createElement("img");b.src="/images/loading_bar.gif";i.appendChild(b);a.pollingTimeoutId=null;return}var f=Math.round((c.progress.current/c.progress.total)*100);a.yuiProgressBar.set("value",f);var h=document.getElementById("progressTextContainer").firstChild;h.nodeValue=f+"%";a.pollingTimeoutId=setTimeout(function(){a.getProgress.call(a)},a.sampleInterval)}},null)}},handleUploadComplete:function(c){try{var g=YAHOO.lang.JSON.parse(c.responseText)}catch(h){if(h instanceof SyntaxError){g=new Object();g.success=false;g.message="Invalid response from server."}else{throw h}}this.pollingEnabled=false;clearTimeout(this.pollingTimeoutId);YAHOO.util.Connect.abort(this.lastAsyncRequest);if(this.yuiProgressBar){this.yuiProgressBar.get("anim").duration=0.5;this.yuiProgressBar.set("value",100)}var a=document.getElementById("progressTextContainer").firstChild;a.nodeValue="Verifying file.";if(!g.success){var b="Upload Failed: "+g.message;var d={zIndex:10000};Fisma.Util.showAlertDialog(b,d);a.nodeValue="Uploading...";document.getElementById("progressBarContainer").style.display="none";document.getElementById("progressTextContainer").style.display="none";var j=document.getElementById("uploadButton");j.disabled=false;return}var i=Fisma[this.config.callback.object];if(typeof i!="Undefined"){var f=i[this.config.callback.method];if(typeof f=="function"){f.call(i,this.yuiPanel)}}},cancelPanel:function(){if(this.pollingEnabled){this.pollingEnabled=false;clearTimeout(this.pollingTimeoutId)}if(this.lastAsyncRequest){YAHOO.util.Connect.abort(this.lastAsyncRequest)}}};